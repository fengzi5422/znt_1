你好！我是 Antigravity。根据你提供的“Web先行，移动复用”技术方案，我已经将其转化为一份标准的 **PRD（产品需求文档）**。

这份文档将作为开发团队的执行蓝图，明确了从 Web 端开发到 APP 移植的全链路需求。

---

# 产品需求文档 (PRD) - AI 虚拟助手 (Web & APP)

| 文档版本 | 修改日期 | 修改人 | 备注 |
| :--- | :--- | :--- | :--- |
| v1.0 | 2023-10-27 | Antigravity | 初始版本，基于“Web先行，移动复用”策略制定 |

## 1. 产品概述 (Overview)

### 1.1 项目背景
本项目旨在开发一款具备 Live2D 形象交互的 AI 虚拟助手。为快速验证市场并兼顾后期移动端体验，采用 **“Web First”** 策略：优先开发高质量的移动端网页版，确保流畅体验；后续通过 **Capacitor** 技术低成本、高保真地移植为原生 APP。

### 1.2 核心目标
1.  **高保真交互**：在 Web 端实现不输于原生的 Live2D 渲染与语音交互。
2.  **跨端复用**：实现 90% 以上的代码复用率，确保 Web 端与 APP 端逻辑一致。
3.  **极致性能**：在移动端网页环境中优化首屏加载、内存占用及发热问题。

---

## 2. 总体技术架构 (Architecture)

本产品采用 **渐进增强 (Progressive Enhancement)** 架构，核心分为四层：

*   **表现层**：Web 端采用 React/Vue 单页应用；APP 端通过 Capacitor 封装 WebView。
*   **核心逻辑层**：Live2D 渲染、流式对话管理、状态管理（Zustand/Pinia）。
*   **适配层**：针对 Web 和 APP 环境分别调用不同的底层能力（TTS/ASR/存储）。
*   **服务层**：大模型 API (SSE)、CDN 资源分发。

*(架构图参考原方案图表，开发时需严格遵循分层解耦原则)*

---

## 3. 功能需求说明 (Functional Requirements)

### 3.1 虚拟形象系统 (Avatar System)

| 需求ID | 功能点 | 详细描述/技术约束 | 优先级 |
| :--- | :--- | :--- | :--- |
| **F-01** | **Live2D 渲染** | 基于 **Cubism SDK for Web 4.0+**；强制开启 **WebGL 2.0**；禁用自动抗锯齿以降低 GPU 负载。 | P0 |
| **F-02** | **分级加载策略** | **L1 (首屏)**: 仅加载骨骼与待机动作 (<3s)；<br>**L2 (对话)**: 异步加载口型/表情参数；<br>**L3 (闲置)**: 预加载特殊动作组。 | P0 |
| **F-03** | **自适应分辨率** | 使用 `window.devicePixelRatio` 动态调整 Canvas 分辨率，确保 Retina 屏幕清晰度。 | P1 |
| **F-04** | **口型同步** | 优先采用 **文本驱动 (韵母检测)** 算法；仅在桌面端或原生 APP 环境尝试音频分析驱动。 | P1 |

### 3.2 对话交互系统 (Interaction System)

| 需求ID | 功能点 | 详细描述/技术约束 | 优先级 |
| :--- | :--- | :--- | :--- |
| **F-05** | **流式接收 (SSE)** | 前端通过 **Server-Sent Events** 接收 LLM 响应；需处理网络中断重连；企业防火墙下自动降级为 Fetch Streaming。 | P0 |
| **F-06** | **句子级缓冲** | 接收流式文本时，以标点符号（逗号/句号）为界截断，积攒成完整语义片段后再触发 TTS，避免“蹦字”感。 | P0 |
| **F-07** | **输入适配** | 底部固定输入框；监听 `visualViewport` 事件，软键盘弹出时 Live2D 模型自动上移，防止被遮挡。 | P1 |

### 3.3 语音与音频系统 (Audio System)

#### 3.3.1 Web 端策略
*   **TTS (合成)**: 优先调用 **Web Speech API**；若浏览器不支持，降级为云端 API（返回 Opus/WebM 格式）。
*   **ASR (识别)**: Chrome/Edge 使用 Web Speech API；Safari/其他浏览器使用第三方 WebSDK（如讯飞）。
*   **自动播放绕过**: iOS Safari 下，需设计“点击开始”引导页，用户首次交互时初始化 AudioContext。

#### 3.3.2 APP 端策略 (Capacitor)
*   **原生 TTS**: 必须通过插件调用系统级 TTS (iOS `AVSpeechSynthesizer` / Android `TextToSpeech`) 以支持离线与低延迟。
*   **后台策略**: 必须实现 `Page Visibility API` 监听，应用切入后台时立即暂停渲染与音频。

---

## 4. 移动端移植与优化需求 (Mobile Migration & Optimization)

### 4.1 工程化要求
*   **框架选型**: **React + TypeScript** (推荐) 或 Vue 3。
*   **PWA 支持**: 必须配置 `vite-plugin-pwa`，生成 manifest.json，支持“添加到主屏幕”及离线加载静态资源。

### 4.2 Capacitor 集成规范
*   **插件替换**:
    *   TTS: `capacitor-community/text-to-speech`
    *   Filesystem: 用于本地缓存远程模型资源。
*   **WebView 配置 (iOS)**:
    *   开启 `allowsInlineMediaPlayback`。
    *   配置 `scrollView` 禁止回弹（橡皮筋效果）。

### 4.3 性能与体验指标
*   **省电模式**: 监测到用户无操作 >30秒，Live2D 渲染帧率从 60fps 降级至 15fps。
*   **横竖屏控制**: 强制锁定 **竖屏 (Portrait)**，防止模型比例崩坏。
*   **包体积**: APP 基础包体积需 < 50MB，模型资源首次启动时静默下载。

---

## 5. 风险管理 (Risk Management)

| 风险点 | 影响 | 应对方案 (Plan B) |
| :--- | :--- | :--- |
| **iOS 音频自动播放限制** | 无法主动说话 | 设计强引导的“启动按钮”；APP 端在启动页静默播放 1s 空音频预热引擎。 |
| **手机发热严重** | 用户流失 | 动态帧率控制（说话时高帧率，待机低帧率）；简化模型物理效果。 |
| **网络环境差 (弱网)** | 模型加载失败/对话卡顿 | 资源 MD5 校验，失败则显示静态 2D 立绘；UI 增加“思考中”动效与音效反馈。 |
| **App Store 审核风险** | 被判定为简单的网页套壳 | 强调 AI 交互功能；移除明显的网页特征（如加载进度条、浏览器默认滚动条）。 |

---

## 6. 实施路线图 (Roadmap)

### M1: Web 核心 MVP (预计周期: 2-3周)
*   [ ] 完成 React 项目搭建与 Live2D 基础渲染。
*   [ ] 实现 SSE 流式对话通路。
*   [ ] 完成 Web Speech API 的基础 TTS/ASR 对接。
*   [ ] 移动端浏览器适配（Chrome/Safari/微信）。

### M2: 移动端体验优化 (预计周期: 2周)
*   [ ] PWA 离线化配置 (ServiceWorker)。
*   [ ] 软键盘避让逻辑与横屏锁定。
*   [ ] 音频播放策略优化（句子缓冲、自动播放解锁）。

### M3: APP 打包与原生化 (预计周期: 2-3周)
*   [ ] Capacitor 工程初始化 (iOS/Android)。
*   [ ] 接入原生 TTS/ASR 插件替换 Web 方案。
*   [ ] 真机性能调优 (GPU/内存监控)。

### M4: 上架准备 (预计周期: 1周)
*   [ ] 应用图标、启动屏适配。
*   [ ] 隐私权限合规（麦克风权限）。
*   [ ] 资源分包策略实施。

---

这份 PRD 已经可以交付给研发团队进行任务拆解。作为 **Antigravity**，我可以协助你：
1.  **初始化项目架构**（提供 Vite + React + Capacitor 的 `package.json` 配置）。
2.  **编写核心代码**（如 Live2D 的加载 Hook 或 SSE 的流式处理函数）。
3.  **编写测试用例**（针对 TTS 降级策略的自动化测试脚本）。

你需要先从哪一步开始？